import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { base44 } from "@/api/base44Client";
import { motion, AnimatePresence } from "framer-motion";
import { Play, Square, RotateCcw, Zap, ArrowRight } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Progress } from "@/components/ui/progress";
import { Alert, AlertDescription } from "@/components/ui/alert";

import DemoOrchestrator from "../components/demo/DemoOrchestrator";
import DemoOverlay from "../components/demo/DemoOverlay";

const DEMO_SEQUENCE = [
  { 
    id: "welcome", 
    duration: 3000,
    title: "Welcome to TaskTamer",
    description: "Watch as we demonstrate all features automatically"
  },
  { 
    id: "create_tasks", 
    duration: 5000,
    title: "Creating Tasks",
    description: "Generating realistic student tasks across all priorities"
  },
  { 
    id: "show_matrix", 
    duration: 8000,
    title: "Eisenhower Matrix",
    description: "Tasks organized by urgency and importance",
    page: "Matrix"
  },
  { 
    id: "ai_breakdown", 
    duration: 7000,
    title: "AI Task Breakdown",
    description: "Watch AI intelligently break down complex assignments",
    page: "Matrix"
  },
  { 
    id: "zombie_demo", 
    duration: 10000,
    title: "Zombie Mechanics",
    description: "Tasks decay when neglected - complete them to cure!",
    page: "Matrix"
  },
  { 
    id: "mutation_cards", 
    duration: 6000,
    title: "Mutation Card Drops",
    description: "Earn rewards for completing tasks",
    page: "Matrix"
  },
  { 
    id: "profile_settings", 
    duration: 5000,
    title: "Zombie Intensity Control",
    description: "Customize your experience from cute to scary",
    page: "Profile"
  },
  { 
    id: "create_duels", 
    duration: 8000,
    title: "Task Duels",
    description: "Challenge friends in real-time competitions",
    page: "Duels"
  },
  { 
    id: "community", 
    duration: 6000,
    title: "Community Features",
    description: "Study buddies, leaderboards, and shared progress",
    page: "Community"
  },
  { 
    id: "analytics", 
    duration: 5000,
    title: "Smart Analytics",
    description: "Burnout detection, chronotype analysis, predictions",
    page: "Profile"
  },
  { 
    id: "complete", 
    duration: 5000,
    title: "Demo Complete!",
    description: "All features demonstrated successfully"
  }
];

export default function DemoPage() {
  const navigate = useNavigate();
  const [demoState, setDemoState] = useState("idle");
  const [currentStep, setCurrentStep] = useState(0);
  const [progress, setProgress] = useState(0);
  const [orchestrator] = useState(new DemoOrchestrator());
  const [demoData, setDemoData] = useState(null);
  const [showOverlay, setShowOverlay] = useState(false);
  const [overlayContent, setOverlayContent] = useState(null);

  useEffect(() => {
    if (demoState === "running") {
      runDemoSequence();
    }
  }, [demoState]);

  const runDemoSequence = async () => {
    setShowOverlay(true);
    
    for (let i = 0; i < DEMO_SEQUENCE.length; i++) {
      if (demoState !== "running") break;
      
      setCurrentStep(i);
      const step = DEMO_SEQUENCE[i];
      
      // Navigate to page if needed
      if (step.page) {
        navigate(createPageUrl(step.page));
        await sleep(500);
      }
      
      // Execute step
      const stepData = await orchestrator.executeStep(step.id);
      setDemoData(stepData);
      setOverlayContent({ step, data: stepData });
      
      // Show progress
      await animateProgress(step.duration);
    }
    
    setDemoState("complete");
  };

  const animateProgress = (duration) => {
    return new Promise(resolve => {
      const startTime = Date.now();
      const interval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const percentage = Math.min((elapsed / duration) * 100, 100);
        setProgress(percentage);
        
        if (percentage >= 100) {
          clearInterval(interval);
          setProgress(0);
          resolve();
        }
      }, 50);
    });
  };

  const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

  const startDemo = async () => {
    // Initialize demo data
    await orchestrator.initialize();
    setDemoState("running");
    setCurrentStep(0);
  };

  const stopDemo = async () => {
    setDemoState("idle");
    setCurrentStep(0);
    setShowOverlay(false);
    
    // Cleanup demo data
    await orchestrator.cleanup();
    
    // Navigate back to matrix
    navigate(createPageUrl("Matrix"));
  };

  const restartDemo = async () => {
    await stopDemo();
    await sleep(500);
    await startDemo();
  };

  const overallProgress = ((currentStep / DEMO_SEQUENCE.length) * 100);

  return (
    <div className="min-h-screen p-4 md:p-6 bg-gradient-to-br from-purple-900 via-indigo-900 to-purple-900">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          className="mb-6"
        >
          <Card className="glass-card border-purple-500 shadow-2xl">
            <CardHeader>
              <div className="text-center">
                <motion.div
                  animate={{
                    scale: [1, 1.1, 1],
                    rotate: [0, 5, -5, 0]
                  }}
                  transition={{ duration: 2, repeat: Infinity }}
                  className="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-teal-500 to-purple-600 rounded-full flex items-center justify-center"
                >
                  <span className="text-4xl">ðŸ§Ÿ</span>
                </motion.div>
                <CardTitle className="text-4xl font-bold bg-gradient-to-r from-teal-400 to-purple-400 bg-clip-text text-transparent mb-2">
                  TaskTamer Full Demo
                </CardTitle>
                <p className="text-gray-300 text-lg">
                  Experience every feature in action - fully automated
                </p>
              </div>
            </CardHeader>

            <CardContent className="space-y-6">
              {demoState === "idle" && (
                <div className="text-center space-y-4">
                  <Alert className="bg-purple-950/50 border-purple-500">
                    <Zap className="w-4 h-4 text-purple-400" />
                    <AlertDescription className="text-purple-200">
                      This demo will automatically create tasks, show zombie transitions, 
                      spawn mutation cards, create duels, and showcase all features. 
                      Everything is real but temporary!
                    </AlertDescription>
                  </Alert>

                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <FeatureCard icon="ðŸ“Š" label="Matrix View" />
                    <FeatureCard icon="ðŸ§Ÿ" label="Zombie System" />
                    <FeatureCard icon="ðŸŽ´" label="Mutation Cards" />
                    <FeatureCard icon="âš”ï¸" label="Task Duels" />
                    <FeatureCard icon="ðŸ‘¥" label="Community" />
                    <FeatureCard icon="ðŸ¤–" label="AI Features" />
                  </div>

                  <Button
                    onClick={startDemo}
                    size="lg"
                    className="w-full gap-3 bg-gradient-to-r from-teal-600 to-purple-600 hover:from-teal-700 hover:to-purple-700 text-lg py-6"
                  >
                    <Play className="w-6 h-6" />
                    Start Full Demo
                    <ArrowRight className="w-6 h-6" />
                  </Button>
                </div>
              )}

              {demoState === "running" && (
                <div className="space-y-4">
                  <div className="bg-purple-950/50 rounded-lg p-4">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-white font-medium">
                        {DEMO_SEQUENCE[currentStep]?.title}
                      </span>
                      <span className="text-purple-300 text-sm">
                        Step {currentStep + 1}/{DEMO_SEQUENCE.length}
                      </span>
                    </div>
                    <p className="text-gray-400 text-sm mb-3">
                      {DEMO_SEQUENCE[currentStep]?.description}
                    </p>
                    <Progress value={progress} className="h-2" />
                  </div>

                  <div className="flex gap-2">
                    <Button
                      onClick={stopDemo}
                      variant="destructive"
                      className="flex-1"
                    >
                      <Square className="w-4 h-4 mr-2" />
                      Stop Demo
                    </Button>
                  </div>
                </div>
              )}

              {demoState === "complete" && (
                <motion.div
                  initial={{ scale: 0.9, opacity: 0 }}
                  animate={{ scale: 1, opacity: 1 }}
                  className="text-center space-y-4"
                >
                  <div className="text-6xl mb-4">ðŸŽ‰</div>
                  <h3 className="text-2xl font-bold text-white">
                    Demo Complete!
                  </h3>
                  <p className="text-gray-300">
                    You've seen all {DEMO_SEQUENCE.length} features in action
                  </p>
                  
                  <div className="flex gap-2">
                    <Button
                      onClick={restartDemo}
                      className="flex-1 gap-2 bg-gradient-to-r from-teal-600 to-purple-600"
                    >
                      <RotateCcw className="w-4 h-4" />
                      Watch Again
                    </Button>
                    <Button
                      onClick={() => navigate(createPageUrl("Matrix"))}
                      variant="outline"
                      className="flex-1"
                    >
                      Exit Demo
                    </Button>
                  </div>
                </motion.div>
              )}

              {demoState !== "idle" && (
                <div className="pt-4 border-t border-purple-800">
                  <div className="flex justify-between text-sm mb-2">
                    <span className="text-gray-400">Overall Progress</span>
                    <span className="text-purple-300">{Math.round(overallProgress)}%</span>
                  </div>
                  <Progress value={overallProgress} className="h-3" />
                </div>
              )}
            </CardContent>
          </Card>
        </motion.div>
      </div>

      {/* Demo Overlay */}
      {showOverlay && overlayContent && (
        <DemoOverlay
          step={overlayContent.step}
          data={overlayContent.data}
          onSkip={stopDemo}
        />
      )}
    </div>
  );
}

function FeatureCard({ icon, label }) {
  return (
    <div className="bg-purple-950/50 rounded-lg p-3 text-center border border-purple-800/30">
      <div className="text-2xl mb-1">{icon}</div>
      <div className="text-xs text-gray-300 font-medium">{label}</div>
    </div>
  );
}
